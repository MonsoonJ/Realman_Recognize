#!/bin/bash

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}=========================================${NC}"
echo -e "${BLUE} æœºæ¢°è‡‚æŠ“å–ç³»ç»Ÿå¯åŠ¨${NC}"
echo -e "${BLUE}=========================================${NC}"
echo

# # æ£€æŸ¥å¹¶æ¿€æ´»condaç¯å¢ƒ
# CURRENT_CONDA_ENV=$(conda info --envs | grep -E '^\*|^[[:space:]]*recogn' | grep -v '^*' | head -1 | awk '{print $1}')
# if [[ "$CURRENT_CONDA_ENV" != "recogn" ]]; then
#     echo -e "${BLUE} åˆ‡æ¢åˆ°recogn condaç¯å¢ƒ...${NC}"
#     conda activate recogn
#     if [[ $? -ne 0 ]]; then
#         echo -e "${YELLOW} æ— æ³•æ¿€æ´»recognç¯å¢ƒï¼Œè¯·ç¡®ä¿å·²å®‰è£…condaä¸”recognç¯å¢ƒå­˜åœ¨${NC}"
#         exit 1
#     fi
#     echo -e "${GREEN} å·²åˆ‡æ¢åˆ°recognç¯å¢ƒ${NC}"
# else
#     echo -e "${GREEN} å·²åœ¨recognç¯å¢ƒä¸­${NC}"
# fi

# echo -e "${GREEN} æ­£åœ¨å¯åŠ¨ç³»ç»Ÿç»„ä»¶...${NC}"
# echo

# è®¾ç½®ç¯å¢ƒ
source install/setup.bash

# 1. å¯åŠ¨ç‘å°”æ›¼æœºæ¢°è‡‚é©±åŠ¨
echo -e "${BLUE}1. å¯åŠ¨æœºæ¢°è‡‚é©±åŠ¨...${NC}"
cd src/rm_robot/rm_bringup/launch
ros2 launch rm_bringup_lite.launch.py &
DRIVER_PID=$!
echo -e "${GREEN}   âœ“ é©±åŠ¨å·²å¯åŠ¨ (PID: $DRIVER_PID)${NC}"

# ç­‰å¾…é©±åŠ¨å¯åŠ¨
sleep 5

# 2. å¯åŠ¨YOLOè§†è§‰è¯†åˆ«
echo -e "${BLUE}2. å¯åŠ¨YOLOè§†è§‰è¯†åˆ«...${NC}"
cd ../..
cd ../..
ros2 run vi_grab yolo_rs_publisher &
VISION_PID=$!
echo -e "${GREEN}   âœ“ è§†è§‰è¯†åˆ«å·²å¯åŠ¨ (PID: $VISION_PID)${NC}"

# ç­‰å¾…è§†è§‰èŠ‚ç‚¹å¯åŠ¨
sleep 3

# 3. å¯åŠ¨åæ ‡å˜æ¢
echo -e "${BLUE}3. å¯åŠ¨åæ ‡å˜æ¢...${NC}"
cd src/vi_grab/vi_grab
python3 camera_to_base.py &
TRANSFORM_PID=$!
echo -e "${GREEN}   âœ“ åæ ‡å˜æ¢å·²å¯åŠ¨ (PID: $TRANSFORM_PID)${NC}"

# ç­‰å¾…åæ ‡å˜æ¢èŠ‚ç‚¹å¯åŠ¨
sleep 3

# 4. å¯åŠ¨æŠ“å–æ‰§è¡Œå™¨
echo -e "${BLUE}4. å¯åŠ¨æŠ“å–æ‰§è¡Œå™¨...${NC}"
python3 grasp_executor3.py &
GRASP_PID=$!
echo -e "${GREEN}   æŠ“å–æ‰§è¡Œå™¨å·²å¯åŠ¨ (PID: $GRASP_PID)${NC}"

echo
echo -e "${GREEN}=========================================${NC}"
echo -e "${GREEN} ç³»ç»Ÿå¯åŠ¨å®Œæˆ ${NC}"
echo -e "${GREEN}=========================================${NC}"
echo
echo -e "${BLUE} å¯åŠ¨çŠ¶æ€:${NC}"
echo -e "${GREEN}   æœºæ¢°è‡‚é©±åŠ¨ - è¿è¡Œä¸­${NC}"
echo -e "${GREEN}   YOLOè§†è§‰è¯†åˆ« - è¿è¡Œä¸­${NC}"
echo -e "${GREEN}   åæ ‡å˜æ¢ - è¿è¡Œä¸­${NC}"
echo -e "${GREEN}   æŠ“å–æ‰§è¡Œå™¨ - è¿è¡Œä¸­${NC}"
echo
echo -e "${BLUE}ğŸ” ç³»ç»ŸçŠ¶æ€: ç­‰å¾…ç›®æ ‡ç‰©ä½“è¯†åˆ«...${NC}"
echo
echo -e "${YELLOW} ä½¿ç”¨è¯´æ˜:${NC}"
echo -e "   â€¢ å°†ç›®æ ‡ç‰©ä½“æ”¾åœ¨ç›¸æœºè§†é‡ä¸­"
echo -e "   â€¢ ç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«å¹¶æŠ“å–ç›®æ ‡"
echo -e "   â€¢ æŒ‰ Ctrl+C åœæ­¢ç³»ç»Ÿ"
echo

# ä¿å­˜PIDåˆ°æ–‡ä»¶
# echo "$DRIVER_PID" > .driver.pid
# echo "$VISION_PID" > .vision.pid
# echo "$TRANSFORM_PID" > .transform.pid
# echo "$GRASP_PID" > .grasp.pid

# ç­‰å¾…ç”¨æˆ·ä¸­æ–­
trap 'echo; echo -e "${YELLOW}æ­£åœ¨åœæ­¢ç³»ç»Ÿ...${NC}"; bash stop.sh; exit 0' INT
wait